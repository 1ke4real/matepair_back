stages:
    - build
    - deploy

variables:
    DOCKER_IMAGE_NAME: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}
    SSH_PRIVATE_KEY: ${CI_DEPLOY_PRIVATE_KEY}
    SSH_KNOWN_HOSTS: ${CI_DEPLOY_KNOWN_HOSTS}
    REMOTE_USER: ${CI_DEPLOY_REMOTE_USER}
    REMOTE_HOST: ${CI_DEPLOY_REMOTE_HOST}
    REMOTE_PATH: /path/to/your/deployment/directory

before_script:
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

build:
    stage: build
    script:
        - docker build -t $DOCKER_IMAGE_NAME .
        - docker push $DOCKER_IMAGE_NAME

deploy:
    stage: deploy
    only:
        - master
    script:
        - ssh $REMOTE_USER@$REMOTE_HOST "mkdir -p $REMOTE_PATH"
        - scp -r ./* $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH
        - ssh $REMOTE_USER@$REMOTE_HOST "cd $REMOTE_PATH && docker-compose pull"
        - ssh $REMOTE_USER@$REMOTE_HOST "cd $REMOTE_PATH && docker-compose up -d"
